{% extends 'base.html' %}

{% block content %}
<div class="p-4 mb-4 bg-light rounded-3">
    <div class="container-fluid py-2">
        <h1 class="display-6 fw-bold">Dashboard Administrativo</h1>
        <p class="col-md-10">Bienvenido, {{ user.username }}. Gestión de resultados y KPIs por líder.</p>
        <div class="d-flex gap-2">
            <a href="/accounts/logout" class="btn btn-danger shadow">Cerrar Sesión</a>
        </div>
    </div>
</div>

<div class="card mb-4">
  <div class="card-body">
    <form class="row g-3" method="get">
      <div class="col-auto">
        <label class="form-label">Año</label>
        <input type="number" class="form-control" name="anio" value="{{ anio }}" min="2020" max="2100" />
      </div>
      <div class="col-auto">
        <label class="form-label">Semestre</label>
        <select class="form-select" name="semestre">
          <option value="1" {% if semestre == '1' %}selected{% endif %}>1 (Ene-Jun)</option>
          <option value="2" {% if semestre == '2' %}selected{% endif %}>2 (Jul-Dic)</option>
        </select>
      </div>
      <div class="col-auto">
        <label class="form-label">Ordenar por</label>
        <select class="form-select" name="ordenar_por">
          <option value="desempeno" {% if ordenar_por == 'desempeno' %}selected{% endif %}>Desempeño</option>
          <option value="avg_conversion" {% if ordenar_por == 'avg_conversion' %}selected{% endif %}>Conv. Ventas</option>
          <option value="avg_cump_recaudo" {% if ordenar_por == 'avg_cump_recaudo' %}selected{% endif %}>Cumpl. Recaudo</option>
          <option value="avg_cump_conv" {% if ordenar_por == 'avg_cump_conv' %}selected{% endif %}>Cumpl. Conversión</option>
          <option value="avg_caidas" {% if ordenar_por == 'avg_caidas' %}selected{% endif %}>Caídas Acuerdos</option>
        </select>
      </div>
      <div class="col-auto">
        <label class="form-label">Dirección</label>
        <select class="form-select" name="direccion">
          <option value="desc" {% if direccion == 'desc' %}selected{% endif %}>Mayor a menor</option>
          <option value="asc" {% if direccion == 'asc' %}selected{% endif %}>Menor a mayor</option>
        </select>
      </div>
      <div class="col-auto align-self-end">
        <button type="submit" class="btn btn-primary"><i class="bi bi-arrow-repeat"></i> Actualizar</button>
      </div>
      <div class="col-auto align-self-end">
        <a class="btn btn-success" href="{% url 'exportar_resultados_excel' %}?anio={{ anio }}&semestre={{ semestre }}">
          <i class="bi bi-file-earmark-excel"></i> Exportar Excel
        </a>
      </div>
    </form>
    <small class="text-muted">Rango: {{ start_date }} a {{ end_date }}</small>
  </div>
</div>

<div class="card">
  <div class="card-header">Indicadores consolidados por líder y negociadores</div>
  <div class="card-body table-responsive">
    <table class="table table-striped align-middle">
      <thead>
        <tr>
          <th style="width: 40px;"></th>
          <th>Líder / Negociador</th>
          <th>Correo / Cédula</th>
          <th>Negociadores</th>
          <th>Conv. Ventas (%)</th>
          <th>Cumpl. Recaudo (%)</th>
          <th>Cumpl. Conversión (%)</th>
          <th>Caídas Acuerdos (%)</th>
          <th>Tiempo Hablando (h)</th>
          <th>Recaudo ($)</th>
          <th>Desempeño</th>
        </tr>
      </thead>
      <tbody>
        {% for l in leaders_data %}
        <tr class="leader-row" style="background-color: #f8f9fa; font-weight: 500;">
          <td>
            {% if l.negociadores %}
            <button class="btn btn-sm btn-outline-primary toggle-negotiators" data-leader="{{ l.cedula }}" type="button">
              <i class="bi bi-chevron-down"></i>
            </button>
            {% endif %}
          </td>
          <td><strong>{{ l.nombre }}</strong></td>
          <td>{{ l.email }}</td>
          <td><span class="badge bg-info text-dark">{{ l.equipos }}</span></td>
          <td>{{ l.avg_conversion|floatformat:2 }}</td>
          <td>{{ l.avg_cump_recaudo|floatformat:2 }}</td>
          <td>{{ l.avg_cump_conv|floatformat:2 }}</td>
          <td>{{ l.avg_caidas|floatformat:2 }}</td>
          <td>{{ l.avg_tiempo|floatformat:2 }}</td>
          <td>${{ l.avg_recaudo|floatformat:0 }}</td>
          <td>
            {% if l.desempeno %}
            <span class="badge {% if l.desempeno >= 80 %}bg-success{% elif l.desempeno >= 60 %}bg-warning text-dark{% else %}bg-danger{% endif %}">
              {{ l.desempeno|floatformat:2 }}
            </span>
            {% else %}
            <span class="text-muted">N/D</span>
            {% endif %}
          </td>
        </tr>
        {% for n in l.negociadores %}
        <tr class="negotiator-row negotiator-{{ l.cedula }}" style="display: none;">
          <td></td>
          <td style="padding-left: 2.5rem;">
            <i class="bi bi-person-fill text-secondary"></i> {{ n.nombre }}
          </td>
          <td class="text-muted">{{ n.cedula }}</td>
          <td>-</td>
          <td>{{ n.avg_conversion|floatformat:2|default:"-" }}</td>
          <td>{{ n.avg_cump_recaudo|floatformat:2|default:"-" }}</td>
          <td>{{ n.avg_cump_conv|floatformat:2|default:"-" }}</td>
          <td>{{ n.avg_caidas|floatformat:2|default:"-" }}</td>
          <td>{{ n.avg_tiempo|floatformat:2|default:"-" }}</td>
          <td>{% if n.avg_recaudo %}${{ n.avg_recaudo|floatformat:0 }}{% else %}-{% endif %}</td>
          <td>
            {% if n.desempeno %}
            <span class="badge {% if n.desempeno >= 80 %}bg-success{% elif n.desempeno >= 60 %}bg-warning text-dark{% else %}bg-danger{% endif %}">
              {{ n.desempeno|floatformat:2 }}
            </span>
            {% else %}
            <span class="text-muted">N/D</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
        {% empty %}
        <tr><td colspan="11" class="text-center text-muted">Sin datos para el rango seleccionado.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="card-footer text-muted">
    Haz clic en el botón <i class="bi bi-chevron-down"></i> para ver los negociadores de cada líder.
  </div>
</div>
<!-- Gráficos resumen para administradores -->
<style>
  /* Force consistent sizes for top charts */
  .dashboard-chart .card-body{ height:360px; }
  .dashboard-chart canvas{ width:100% !important; height:100% !important; }
</style>
<div class="row mt-4">
  <div class="col-md-6">
    <div class="card mb-3 dashboard-chart">
      <div class="card-header">Participación de negociadores por líder (%)</div>
      <div class="card-body">
        <canvas id="chartShare"></canvas>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card mb-3 dashboard-chart">
      <div class="card-header">Conteo de negociadores por líder</div>
      <div class="card-body">
        <canvas id="chartCounts"></canvas>
      </div>
    </div>
  </div>
  <div class="col-md-12">
    <div class="card mb-3 dashboard-chart">
      <div class="card-header">Desempeño promedio por líder</div>
      <div class="card-body">
        <canvas id="chartDesempeno"></canvas>
      </div>
    </div>
  </div>
</div>
<!-- KPI canvases grid -->
<div class="row mt-4">
  <div class="col-md-4 mb-3"><div class="card"><div class="card-header">Recaudo promedio</div><div class="card-body" style="height:180px"><canvas id="chartRecaudo"></canvas></div></div></div>
  <div class="col-md-4 mb-3"><div class="card"><div class="card-header">Tiempo hablando</div><div class="card-body" style="height:180px"><canvas id="chartTiempo"></canvas></div></div></div>
  <div class="col-md-4 mb-3"><div class="card"><div class="card-header">Conversión de ventas</div><div class="card-body" style="height:180px"><canvas id="chartConversion"></canvas></div></div></div>
  <div class="col-md-4 mb-3"><div class="card"><div class="card-header">Cumpl. Recaudo</div><div class="card-body" style="height:180px"><canvas id="chartCumpRecaudo"></canvas></div></div></div>
  <div class="col-md-4 mb-3"><div class="card"><div class="card-header">Cumpl. Conversión</div><div class="card-body" style="height:180px"><canvas id="chartCumpConv"></canvas></div></div></div>
  <div class="col-md-4 mb-3"><div class="card"><div class="card-header">Caídas Acuerdos</div><div class="card-body" style="height:180px"><canvas id="chartCaidas"></canvas></div></div></div>
</div>

{% block extra_scripts %}
<!-- Chart.js y plugin de datalabels desde CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
  document.addEventListener('DOMContentLoaded', function(){
    // Toggle negociadores
    document.querySelectorAll('.toggle-negotiators').forEach(btn => {
      btn.addEventListener('click', function() {
        const leaderCedula = this.getAttribute('data-leader');
        const negotiatorRows = document.querySelectorAll('.negotiator-' + leaderCedula);
        const icon = this.querySelector('i');
        
        negotiatorRows.forEach(row => {
          if (row.style.display === 'none') {
            row.style.display = '';
          } else {
            row.style.display = 'none';
          }
        });
        
        // Toggle icono
        if (icon.classList.contains('bi-chevron-down')) {
          icon.classList.remove('bi-chevron-down');
          icon.classList.add('bi-chevron-up');
        } else {
          icon.classList.remove('bi-chevron-up');
          icon.classList.add('bi-chevron-down');
        }
      });
    });

    const labels = {{ chart_labels|safe }};
    const counts = {{ chart_counts|safe }};
    const shares = {{ chart_shares|safe }};
    const avgDesempeno = {{ chart_avg_desempeno|safe }};

    // Doughnut chart: participation with percentage labels
    const ctxShare = document.getElementById('chartShare').getContext('2d');
    new Chart(ctxShare, {
      type: 'doughnut',
      data: {
        labels: labels,
        datasets: [{
          data: shares,
          backgroundColor: labels.map((_,i)=>`hsl(${(i*60)%360} 70% 55%)`),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {position: 'right'},
          datalabels: {
            color: '#fff',
            formatter: (value) => value + '%',
            font: {weight: '600'},
          },
          tooltip: {
            callbacks: {
              label: function(context) { return context.label + ': ' + context.parsed + '%'; }
            }
          }
        }
      },
      plugins: [ChartDataLabels]
    });

    // Horizontal bar chart: counts per leader (refinado para conteos)
    const ctxCounts = document.getElementById('chartCounts').getContext('2d');
    new Chart(ctxCounts, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Negociadores',
          data: counts,
          backgroundColor: 'rgba(54, 162, 235, 0.95)',
          borderRadius: 8,
          barThickness: 28,
          maxBarThickness: 40
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            beginAtZero: true,
            ticks: {
              stepSize: 1,
              callback: function(value){ return Number.isInteger(value) ? value : ''; }
            },
            grid: { drawOnChartArea: false }
          },
          y: { ticks: { autoSkip: false } }
        },
        plugins: {
          legend: { display: false },
          datalabels: {
            anchor: 'end',
            align: 'right',
            color: '#fff',
            backgroundColor: 'rgba(0,0,0,0.28)',
            borderRadius: 4,
            padding: 6,
            formatter: function(value){ return value; }
          },
          tooltip: {
            callbacks: {
              label: function(context){ return context.label + ': ' + context.parsed.x; }
            }
          }
        }
      },
      plugins: [ChartDataLabels]
    });

    // Bar chart: avg desempeño con etiquetas
    const ctxDes = document.getElementById('chartDesempeno').getContext('2d');
    new Chart(ctxDes, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Desempeño promedio',
          data: avgDesempeno,
          backgroundColor: avgDesempeno.map(v=> v>=80 ? 'rgba(40,167,69,0.9)' : v>=60 ? 'rgba(255,193,7,0.95)' : 'rgba(220,53,69,0.95)')
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { beginAtZero: true, max: 100 } },
        plugins: {
          legend: { display: false },
          datalabels: {
            color: '#000',
            anchor: 'end',
            align: 'start',
            formatter: (value) => value
          }
        }
      },
      plugins: [ChartDataLabels]
    });
    
    // === Additional KPI charts (uniform sizing) ===
    const kpiCharts = [
      {id: 'chartRecaudo', label: 'Recaudo promedio ($)', data: {{ chart_avg_recaudo|safe }}, suggestedMax: null},
      {id: 'chartTiempo', label: 'Tiempo hablando (h)', data: {{ chart_avg_tiempo|safe }}, suggestedMax: null},
      {id: 'chartConversion', label: 'Conv. Ventas (%)', data: {{ chart_avg_conversion|safe }}, suggestedMax: 100},
      {id: 'chartCumpRecaudo', label: 'Cumpl. Recaudo (%)', data: {{ chart_avg_cump_recaudo|safe }}, suggestedMax: 100},
      {id: 'chartCumpConv', label: 'Cumpl. Conversión (%)', data: {{ chart_avg_cump_conv|safe }}, suggestedMax: 100},
      {id: 'chartCaidas', label: 'Caídas Acuerdos (%)', data: {{ chart_avg_caidas|safe }}, suggestedMax: 100}
    ];

    kpiCharts.forEach(cfg => {
      const el = document.getElementById(cfg.id);
      if(!el) return;
      new Chart(el.getContext('2d'), {
        type: 'bar',
        data: { labels: labels, datasets: [{ label: cfg.label, data: cfg.data, backgroundColor: 'rgba(123, 97, 255, 0.85)' }] },
        options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, suggestedMax: cfg.suggestedMax } }, plugins:{ legend:{display:false}, datalabels:{color:'#000', anchor:'end', align:'start', formatter: v=>v } } },
        plugins:[ChartDataLabels]
      });
    });
  });
</script>
{% endblock %}

{% endblock %}
